<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tokyo Travel OS</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#F9F9F7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Round|Material+Icons+Outlined" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@500;700&family=Lato:wght@400;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #F9F9F7;
            --card-bg: #FFFFFF;
            --text-main: #1A1A1A;
            --text-sub: #666666;
            --accent: #C5A059;
            --red: #D9534F;
            --shadow: 0 4px 20px rgba(0,0,0,0.06);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        body {
            background-color: #E0E0E0;
            margin: 0; padding: 0;
            font-family: 'Lato', 'Noto Serif TC', sans-serif;
            color: var(--text-main);
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            display: flex; justify-content: center;
            min-height: 100vh;
        }

        #app-container {
            width: 100%; max-width: 430px;
            background-color: var(--bg);
            min-height: 100vh; position: relative;
            box-shadow: 0 0 40px rgba(0,0,0,0.1);
            padding-bottom: calc(90px + var(--safe-bottom));
            overflow-x: hidden;
        }

        header {
            padding: max(20px, env(safe-area-inset-top)) 20px 10px;
            background: var(--bg); position: sticky; top: 0; z-index: 50;
            text-align: center; border-bottom: 1px solid rgba(0,0,0,0.03);
        }
        .trip-title { font-size: 1.5rem; font-weight: 700; letter-spacing: 2px; }
        .trip-date { font-size: 0.8rem; color: #888; font-family: 'Inter'; letter-spacing: 1px; margin-top: 5px; }

        /* å¤©æ°£æ¨¡çµ„ (å‡ç´šç‰ˆ) */
        .weather-card {
            background: #fff; margin: 15px 20px; padding: 15px; border-radius: 16px;
            box-shadow: var(--shadow); display: flex; align-items: center; justify-content: space-between;
        }
        .wc-main { display: flex; align-items: center; gap: 10px; }
        .wc-temp { font-size: 2.5rem; font-weight: 700; font-family: 'Inter'; }
        .wc-detail { font-size: 0.8rem; color: #888; display: flex; flex-direction: column; }
        .wc-icon { font-size: 3rem; }
        .wc-scroll {
            display: flex; gap: 15px; overflow-x: auto; padding: 0 20px 10px;
            scrollbar-width: none; margin-top: -10px;
        }
        .w-item { text-align: center; min-width: 45px; opacity: 0.7; }
        .w-time { font-size: 0.7rem; }
        .w-temp { font-size: 0.8rem; font-weight: 700; }

        /* æ—¥æœŸæ²è»¸ */
        .date-scroll {
            display: flex; gap: 12px; overflow-x: auto; padding: 10px 20px;
            scrollbar-width: none; position: sticky; top: 85px; z-index: 49; background: var(--bg);
        }
        .date-scroll::-webkit-scrollbar { display: none; }
        .date-item {
            min-width: 50px; height: 70px; background: #fff; border-radius: 35px;
            border: 1px solid #eee; display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: var(--shadow); transition: 0.2s; cursor: pointer;
        }
        .date-item.active { background: var(--text-main); color: #fff; transform: translateY(-3px); border-color: var(--text-main); }
        .date-day { font-size: 0.6rem; letter-spacing: 1px; margin-bottom: 2px; }
        .date-num { font-size: 1.3rem; font-weight: 700; font-family: 'Inter'; }

        .timeline-box { padding: 20px; position: relative; }
        .card {
            background: #fff; border-radius: 12px; padding: 20px; margin-bottom: 20px;
            box-shadow: var(--shadow); position: relative; border: 1px solid rgba(0,0,0,0.03);
            cursor: pointer; transition: 0.2s;
        }
        .card:active { transform: scale(0.98); }
        .card-time { font-family: 'Inter'; font-weight: 600; font-size: 1.2rem; color: var(--accent); margin-bottom: 5px; }
        .card-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 5px; line-height: 1.4; }
        .card-sub { font-size: 0.85rem; color: #888; display: flex; align-items: center; gap: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        .card-actions { position: absolute; top: 15px; right: 15px; display: flex; gap: 8px; z-index: 10; }
        .card-btn { color: #ccc; cursor: pointer; padding: 5px; font-size: 20px; }
        .card-btn:hover { color: var(--text-main); }
        .card-btn.del { color: #ffadad; }

        /* æ†‘è­‰åˆ—è¡¨ */
        .booking-list { padding: 20px; }
        .bk-card {
            background: #fff; border-radius: 12px; overflow: hidden; margin-bottom: 20px;
            box-shadow: var(--shadow); border: 1px solid #eee; position: relative;
        }
        .bk-header { padding: 12px 15px; background: #FAFAFA; border-bottom: 1px dashed #ddd; display: flex; justify-content: space-between; color: #888; font-size: 0.8rem; font-weight: 700; align-items: center;}
        .bk-body { padding: 20px; }
        .bk-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 15px; }
        .bk-code-label { font-size: 0.7rem; color: #aaa; letter-spacing: 1px; }
        .bk-code { font-size: 1.6rem; font-family: 'Inter'; font-weight: 700; color: var(--text-main); letter-spacing: 1px; margin-top: 2px; }
        .bk-actions { padding: 12px 15px; border-top: 1px solid #eee; display: flex; gap: 10px; }
        .btn-link { 
            flex: 1; text-align: center; padding: 10px; border-radius: 8px; 
            background: var(--text-main); color: #fff; text-decoration: none; font-size: 0.9rem; font-weight: 700;
        }

        /* è³‡è¨Šé  */
        .info-container { padding: 20px; }
        .map-card {
            height: 180px; background: #eee; border-radius: 12px; position: relative; overflow: hidden;
            display: flex; align-items: center; justify-content: center; color: #999; margin-bottom: 20px;
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/6/6d/Map_of_Tokyo_Special_Wards_and_cities_and_villages.svg/1200px-Map_of_Tokyo_Special_Wards_and_cities_and_villages.svg.png');
            background-size: cover; background-position: center;
        }
        .map-btn {
            position: absolute; bottom: 15px; left: 15px; right: 15px;
            background: #fff; padding: 12px; text-align: center; border-radius: 8px;
            font-weight: 700; font-size: 0.9rem; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            color: var(--text-main); text-decoration: none; display: block;
        }
        .vjw-card {
            background: linear-gradient(135deg, #1f1f1f, #3a3a3a); color: #fff;
            padding: 25px; border-radius: 12px; position: relative; margin-bottom: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2); cursor: pointer;
        }
        .vjw-tag { background: var(--red); font-size: 0.6rem; padding: 3px 8px; border-radius: 4px; margin-bottom: 8px; display: inline-block; }
        .em-grid { display: flex; gap: 15px; margin-bottom: 20px; }
        .em-box { flex: 1; background: #fff; padding: 20px; text-align: center; border-radius: 12px; box-shadow: var(--shadow); }
        .em-num { font-size: 2.2rem; font-weight: 700; color: var(--red); font-family: 'Inter'; display: block; margin-top: 5px; }
        .em-label { font-size: 0.7rem; color: #999; letter-spacing: 1px; }
        .taxi-card {
            background: #fff; padding: 20px; border-radius: 12px; box-shadow: var(--shadow); border-left: 5px solid var(--text-main);
        }
        .taxi-jp { font-size: 1.4rem; font-weight: 700; font-family: 'Noto Serif TC'; margin: 10px 0; }

        /* è¨˜å¸³ */
        .wallet-header { text-align: center; padding: 30px 20px; }
        .wallet-total { font-size: 3rem; font-weight: 700; font-family: 'Inter'; }
        
        .filter-row { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .filter-btn {
            width: 40px; height: 40px; border-radius: 50%; border: 1px solid #ddd;
            background: #fff; color: #999; display: flex; align-items: center; justify-content: center;
            font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: 0.2s;
        }
        .filter-btn.active { background: var(--text-main); color: #fff; border-color: var(--text-main); }
        
        .exp-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #eee; }
        .exp-btns { display: flex; gap: 5px; margin-left: 10px; }

        /* å°èˆªåˆ— */
        .nav-bar {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            border-top: 1px solid rgba(0,0,0,0.05); padding: 10px 0 calc(10px + var(--safe-bottom));
            display: flex; justify-content: space-around; z-index: 100;
        }
        .nav-item { text-align: center; color: #ccc; cursor: pointer; flex: 1; }
        .nav-item.active { color: var(--text-main); }
        .nav-icon { font-size: 24px; display: block; margin-bottom: 2px; }
        .nav-label { font-size: 0.65rem; font-weight: 700; letter-spacing: 1px; }

        .fab-main {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 60px; height: 60px; background: var(--text-main); border-radius: 50%;
            color: #fff; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); cursor: pointer; z-index: 101;
            border: 4px solid #fff;
        }

        /* AI æˆ°æƒ…å®¤æŒ‰éˆ• */
        .ai-fab {
            position: fixed; bottom: 100px; right: 20px;
            width: 52px; height: 52px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: 50%;
            color: #fff; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); cursor: pointer; z-index: 90;
            border: 2px solid #fff;
        }

        /* AI æˆ°æƒ…å®¤é¢æ¿ */
        .ai-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 2000; display: none;
            justify-content: center; align-items: flex-end;
        }
        .ai-overlay.show { display: flex; }
        .ai-box {
            width: 100%; max-width: 430px; background: #fff;
            border-radius: 20px 20px 0 0; padding: 30px 25px; box-sizing: border-box;
            padding-bottom: calc(40px + var(--safe-bottom));
        }
        .ai-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 20px; text-align: center; }
        .ai-btn {
            display: flex; align-items: center; width: 100%; padding: 15px; margin-bottom: 12px;
            border: 1px solid #eee; border-radius: 12px; text-decoration: none; color: #333;
            font-weight: 600; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .ai-btn:active { background: #f5f5f5; }
        .ai-btn span { margin-right: 15px; font-size: 24px; }

        /* è©³æƒ…é  */
        .detail-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 1500; display: none;
            justify-content: center; align-items: flex-end;
        }
        .detail-modal.show { display: flex; }
        .detail-sheet {
            width: 100%; max-width: 430px; height: 85vh; background: #fff;
            border-radius: 20px 20px 0 0; overflow-y: auto; position: relative;
            animation: slideUp 0.3s;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .dt-cover { 
            height: 250px; background: #eee; position: relative; cursor: pointer; 
            background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; color: #999;
        }
        .dt-close { 
            position: absolute; top: 20px; right: 20px; width: 40px; height: 40px; 
            background: rgba(0,0,0,0.6); border-radius: 50%; color: #fff; 
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; z-index: 1600; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .dt-content { padding: 25px; }
        .dt-label { font-size: 0.7rem; color: var(--accent); letter-spacing: 2px; text-transform: uppercase; font-weight: 700; }
        .dt-title { font-size: 1.8rem; font-weight: 700; margin: 5px 0 10px; }
        .dt-desc { font-size: 1rem; color: #444; line-height: 1.8; margin-top: 20px; border-left: 3px solid #eee; padding-left: 15px; }

        .sheet-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); z-index: 2999; display: none; 
        }
        .sheet-overlay.show { display: block; }
        .sheet { 
            width: 100%; max-width: 430px; background: #fff; 
            border-radius: 20px 20px 0 0; padding: 25px; box-sizing: border-box; 
            transform: translateY(100%); transition: 0.3s; 
            padding-bottom: calc(30px + var(--safe-bottom));
            position: fixed; bottom: 0; left: 0; right: 0; margin: 0 auto; 
            z-index: 3000;
        }
        .sheet.show { transform: translateY(0); }
        
        .type-row { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px;}
        .type-btn { padding: 8px 16px; border: 1px solid #eee; border-radius: 20px; font-size: 0.9rem; white-space: nowrap; cursor: pointer; }
        .type-btn.active { background: var(--text-main); color: #fff; }
        .inp { width: 100%; padding: 14px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 12px; font-size: 1rem; box-sizing: border-box; background: #f9f9f9; outline: none; }
        .btn-main { width: 100%; padding: 15px; background: var(--text-main); color: #fff; border: none; border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer; }
        
        .view { display: none; }
        .view.active { display: block; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="app-container">
    
    <header>
        <div class="trip-title">TOKYO TRIP</div>
        <div class="trip-date">2026.09.13 - 09.22</div>
    </header>

    <div id="view-trip" class="view active">
        <div class="weather-card" id="weather-card">
            <div>
                <div style="font-size:0.8rem; color:#999; margin-bottom:5px;">TOKYO (LIVE)</div>
                <div class="wc-main">
                    <span class="wc-icon" id="wc-icon">ğŸŒ¤ï¸</span>
                    <span class="wc-temp" id="wc-temp">--Â°</span>
                </div>
            </div>
            <div class="wc-detail">
                <span id="wc-max">H: --Â°</span>
                <span id="wc-min">L: --Â°</span>
                <span id="wc-rain" style="color:#4facfe; margin-top:5px;">ğŸ’§ --%</span>
            </div>
        </div>
        <div class="wc-scroll" id="weather-scroll"></div>

        <div class="date-scroll" id="date-list"></div>
        <div class="timeline-box" id="itinerary-list"></div>
    </div>

    <div id="view-ticket" class="view">
        <div style="padding:20px; text-align:center; color:#999; font-size:0.8rem; letter-spacing:1px;">BOOKINGS & TICKETS</div>
        <div class="booking-list" id="booking-list"></div>
    </div>

    <div id="view-info" class="view">
        <div class="info-container">
            <div class="map-card">
                <a href="https://www.google.com/maps/place/Tokyo" target="_blank" class="map-btn">é–‹å•Ÿ Google Maps å°èˆª</a>
            </div>
            <div class="vjw-card" onclick="window.open('https://www.vjw.digital.go.jp/','_blank')">
                <span class="vjw-tag">MUST HAVE</span>
                <div style="font-size:1.4rem; font-weight:700;">Visit Japan Web</div>
                <div style="font-size:0.8rem; opacity:0.7;">å…¥å¢ƒå¯©æŸ¥ & æµ·é—œç”³å ± QR Code</div>
                <span class="material-icons-outlined" style="position:absolute; right:20px; top:50%; transform:translateY(-50%); font-size:32px; opacity:0.5;">qr_code_2</span>
            </div>
            <div class="em-grid">
                <div class="em-box">
                    <span class="em-label">è­¦å¯Ÿ (POLICE)</span>
                    <span class="em-num">110</span>
                </div>
                <div class="em-box">
                    <span class="em-label">æ•‘è­·/ç«è­¦</span>
                    <span class="em-num">119</span>
                </div>
            </div>
            <div style="background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.05); margin-bottom:20px;">
                <div style="font-weight:700;">è¨ªæ—¥å¤–åœ‹äººé†«ç™‚ç†±ç·š</div>
                <div style="font-size:1.6rem; font-weight:700; margin:5px 0;">050-3816-2787</div>
                <div style="font-size:0.7rem; color:#999;">24å°æ™‚å°æ‡‰ (è‹±/ä¸­/éŸ“)</div>
            </div>
            <div class="taxi-card">
                <div style="font-size:0.8rem; color:#999;">çµ¦å¸æ©Ÿ (TO DRIVER)</div>
                <div class="taxi-jp">ã“ã“ã¸è¡Œã£ã¦ãã ã•ã„ã€‚</div>
                <div style="font-size:0.8rem; color:#999;">(è«‹è¼‰æˆ‘åˆ°é€™è£¡)</div>
            </div>
        </div>
    </div>

    <div id="view-wallet" class="view">
        <div class="wallet-header">
            <div style="color:#999; font-size:0.8rem;">ç¸½æ”¯å‡º (TWD)</div>
            <div class="wallet-total" id="wallet-total">$0</div>
            <div class="filter-row" style="margin-top:15px;">
                <div class="filter-btn active" onclick="filterWallet('ALL', this)">å…¨</div>
                <div class="filter-btn" onclick="filterWallet('Y', this)">Y</div>
                <div class="filter-btn" onclick="filterWallet('O', this)">O</div>
                <div class="filter-btn" onclick="filterWallet('E', this)">E</div>
                <div class="filter-btn" onclick="filterWallet('S', this)">S</div>
            </div>
        </div>
        <div id="wallet-list" style="padding:0 20px;"></div>
    </div>

    <div class="ai-fab" onclick="toggleAI(true)">
        <span class="material-icons-round">smart_toy</span>
    </div>

    <div class="ai-overlay" id="ai-modal" onclick="toggleAI(false)">
        <div class="ai-box" onclick="event.stopPropagation()">
            <div class="ai-title">AI æ™ºèƒ½æˆ°æƒ…å®¤</div>
            
            <a href="https://translate.google.com/?sl=zh-TW&tl=ja" target="_blank" class="ai-btn">
                <span class="material-icons-round" style="color:#4285F4;">translate</span> Google ç¿»è­¯ (ä¸­æ—¥)
            </a>
            
            <a href="https://chat.openai.com/" target="_blank" class="ai-btn">
                <span class="material-icons-round" style="color:#10a37f;">psychology</span> é–‹å•Ÿ ChatGPT
            </a>
            
            <a href="https://www.perplexity.ai/" target="_blank" class="ai-btn">
                <span class="material-icons-round" style="color:#2d96a1;">travel_explore</span> Perplexity (å³æ™‚è³‡è¨Š)
            </a>

            <div class="ai-btn" onclick="copySchedule()" style="background:#f0f7ff; border-color:#4facfe; cursor:pointer;">
                <span class="material-icons-round" style="color:#4facfe;">content_copy</span> è¤‡è£½ä»Šæ—¥è¡Œç¨‹ (çµ¦ AI ç”¨)
            </div>
            
            <div style="text-align:center; color:#999; margin-top:20px; font-size:0.8rem;">é»æ“Šä¸Šæ–¹æŒ‰éˆ•è¤‡è£½è¡Œç¨‹ï¼Œå†è²¼çµ¦ AI è©¢å•å»ºè­°ã€‚</div>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchView('view-trip', this)">
            <span class="material-icons-round nav-icon">map</span><span class="nav-label">è¡Œç¨‹</span>
        </div>
        <div class="nav-item" onclick="switchView('view-ticket', this)">
            <span class="material-icons-round nav-icon">confirmation_number</span><span class="nav-label">æ†‘è­‰</span>
        </div>
        <div style="width:60px;"></div>
        <div class="nav-item" onclick="switchView('view-info', this)">
            <span class="material-icons-round nav-icon">info</span><span class="nav-label">è³‡è¨Š</span>
        </div>
        <div class="nav-item" onclick="switchView('view-wallet', this)">
            <span class="material-icons-round nav-icon">account_balance_wallet</span><span class="nav-label">è¨˜å¸³</span>
        </div>
    </div>

    <div class="fab-main" onclick="openSheet()"><span class="material-icons-round" style="font-size:32px;">add</span></div>

    <div class="sheet-overlay" id="sheet-overlay" onclick="closeSheet()"></div>
    <div class="sheet" id="sheet-panel">
        <h3 style="margin-top:0;" id="sheet-title">æ–°å¢é …ç›®</h3>
        <div class="type-row">
            <div class="type-btn active" onclick="setType('spot', this)">ğŸ“ è¡Œç¨‹</div>
            <div class="type-btn" onclick="setType('ticket', this)">ğŸ« æ†‘è­‰</div>
            <div class="type-btn" onclick="setType('exp', this)">ğŸ’° è¨˜å¸³</div>
        </div>

        <div id="form-spot">
            <select id="inp-day" class="inp"></select>
            <input type="time" id="inp-time" class="inp" value="10:00">
            <input type="text" id="inp-title" class="inp" placeholder="åœ°é» / æ¨™é¡Œ">
            <textarea id="inp-desc" class="inp" rows="3" placeholder="ä»‹ç´¹ / æ”»ç•¥ / ç­†è¨˜"></textarea>
        </div>

        <div id="form-ticket" class="hidden">
            <input type="text" id="tk-title" class="inp" placeholder="æ¨™é¡Œ (ä¾‹: é£¯åº—åç¨±)">
            <input type="text" id="tk-code" class="inp" placeholder="è¨‚ä½ä»£ç¢¼ / ç¢ºèªè™Ÿ">
            <input type="text" id="tk-link" class="inp" placeholder="é€£çµç¶²å€ (http...)">
            <input type="text" id="tk-note" class="inp" placeholder="å‚™è¨» (ä¾‹: Day 1 å…¥ä½)">
        </div>

        <div id="form-exp" class="hidden">
            <input type="number" id="exp-amt" class="inp" placeholder="é‡‘é¡ (JPY)" oninput="calcRate()">
            <div style="text-align:right; color:#888; font-size:0.8rem; margin-bottom:10px;">ç´„å°å¹£ <span id="twd-preview" style="color:var(--text-main); font-weight:bold;">0</span></div>
            <input type="text" id="exp-item" class="inp" placeholder="é …ç›®">
            <div class="filter-row" style="justify-content:flex-start;">
                <div class="filter-btn" onclick="setPayer('Y', this)">Y</div>
                <div class="filter-btn" onclick="setPayer('O', this)">O</div>
                <div class="filter-btn" onclick="setPayer('E', this)">E</div>
                <div class="filter-btn" onclick="setPayer('S', this)">S</div>
            </div>
        </div>

        <button class="btn-main" onclick="saveItem()">å„²å­˜</button>
    </div>

    <div class="detail-modal" id="detail-modal">
        <div class="detail-sheet">
            <div class="dt-close" onclick="closeDetail()"><span class="material-icons-round" style="font-size:24px;">close</span></div>
            <div class="dt-cover" id="dt-cover" onclick="triggerPhotoUpload()">
                <span id="dt-cover-text">é»æ“Šæ–°å¢ç…§ç‰‡ (PHOTO)</span>
            </div>
            <div class="dt-content">
                <div class="dt-label" id="dt-label">SPOT</div>
                <div class="dt-title" id="dt-title">æ¨™é¡Œ</div>
                <div class="dt-desc" id="dt-desc">ä»‹ç´¹...</div>
            </div>
        </div>
    </div>
    
    <input type="file" id="file-input" style="display:none;" accept="image/*" onchange="handlePhotoUpload(this)">

</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCbrzyXFiRYxGyt6crsRTQNQ5lfZnz65kA",
        authDomain: "tokyo-trip-2026-acfe6.firebaseapp.com",
        databaseURL: "https://tokyo-trip-2026-acfe6-default-rtdb.firebaseio.com",
        projectId: "tokyo-trip-2026-acfe6",
        storageBucket: "tokyo-trip-2026-acfe6.firebasestorage.app",
        messagingSenderId: "345730464055",
        appId: "1:345730464055:web:662b4c0391f893828c42b2",
        measurementId: "G-FKTG3ERB29"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentDay = 1;
    let currentType = 'spot';
    let selectedPayer = 'Y';
    let editingId = null;
    let currentDetailId = null;
    let allSchedule = [];
    const rate = 0.22;

    init();

    function init() {
        const dList = document.getElementById('date-list');
        const dSel = document.getElementById('inp-day');
        for(let i=1; i<=10; i++) {
            dList.innerHTML += `<div class="date-item ${i===1?'active':''}" onclick="setDay(${i}, this)"><span class="date-day">DAY</span><span class="date-num">${i}</span></div>`;
            dSel.innerHTML += `<option value="${i}">Day ${i}</option>`;
        }
        loadData();
        loadWeather();
        const firstPayer = document.querySelector('#form-exp .filter-btn');
        if(firstPayer) firstPayer.classList.add('active');
    }

    async function loadWeather() {
        // æŠ“å–è©³ç´°å¤©æ°£ (å«æœ€é«˜/æœ€ä½/é™é›¨)
        try {
            const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=35.6895&longitude=139.6917&hourly=weathercode,temperature_2m&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=Asia%2FTokyo&forecast_days=1');
            const data = await res.json();
            
            // æ¯æ—¥è³‡è¨Š
            const daily = data.daily;
            document.getElementById('wc-max').innerText = `H: ${Math.round(daily.temperature_2m_max[0])}Â°`;
            document.getElementById('wc-min').innerText = `L: ${Math.round(daily.temperature_2m_min[0])}Â°`;
            document.getElementById('wc-rain').innerText = `ğŸ’§ ${daily.precipitation_probability_max[0]}%`;
            
            // ç›®å‰è³‡è¨Š (å–ç¾åœ¨æ™‚é–“)
            const currentHour = new Date().getHours();
            const currentTemp = Math.round(data.hourly.temperature_2m[currentHour]);
            document.getElementById('wc-temp').innerText = `${currentTemp}Â°`;
            
            // æ°£è±¡ä»£ç¢¼ç°¡å–®è½‰æ›
            const code = daily.weathercode[0];
            let icon = 'â˜ï¸';
            if(code <= 3) icon = 'â˜€ï¸';
            else if(code <= 60) icon = 'ğŸŒ§ï¸';
            else if(code <= 80) icon = 'â˜”';
            else icon = 'â›ˆï¸';
            document.getElementById('wc-icon').innerText = icon;

            // æ²è»¸
            const scroll = document.getElementById('weather-scroll');
            scroll.innerHTML = '';
            for(let i=8; i<=20; i+=3) {
                const t = data.hourly.time[i].split('T')[1];
                const temp = Math.round(data.hourly.temperature_2m[i]);
                scroll.innerHTML += `<div class="w-item"><div class="w-time">${t}</div><div class="w-temp">${temp}Â°</div></div>`;
            }
        } catch(e){ console.log(e); }
    }

    function setDay(d, el) {
        currentDay = d;
        document.querySelectorAll('.date-item').forEach(e=>e.classList.remove('active'));
        el.classList.add('active');
        renderSchedule();
    }

    function loadData() {
        db.ref('schedule').on('value', snap => {
            const data = snap.val();
            allSchedule = [];
            if(data) {
                for(let k in data) allSchedule.push({id:k, ...data[k]});
                renderSchedule();
            }
        });

        db.ref('tickets').on('value', snap => {
            const list = document.getElementById('booking-list');
            list.innerHTML = '';
            const data = snap.val();
            if(data) {
                Object.entries(data).forEach(([k, item]) => {
                    const link = item.link ? `<a href="${item.link}" target="_blank" class="btn-link">é–‹å•Ÿé€£çµ</a>` : '';
                    // æ†‘è­‰çš„ç·¨è¼¯æŒ‰éˆ•
                    list.innerHTML += `
                    <div class="bk-card">
                        <div class="bk-header">
                            <span>${item.note || 'TICKET'}</span>
                            <div style="display:flex; gap:10px;">
                                <span class="material-icons-outlined card-btn" onclick='editTicket(${JSON.stringify({id:k, ...item})})'>edit</span>
                                <span class="material-icons-outlined card-btn del" onclick="delItem('tickets','${k}')">delete</span>
                            </div>
                        </div>
                        <div class="bk-body">
                            <div class="bk-title">${item.title}</div>
                            <span class="bk-code-label">CODE</span>
                            <div class="bk-code">${item.code}</div>
                        </div>
                        <div class="bk-actions">${link}</div>
                    </div>`;
                });
            } else { list.innerHTML='<div style="text-align:center; padding:30px; color:#ccc;">å°šç„¡æ†‘è­‰ï¼Œè«‹æŒ‰ + æ–°å¢</div>'; }
        });

        loadWallet();
    }

    function renderSchedule() {
        const list = document.getElementById('itinerary-list');
        list.innerHTML = '';
        let dayItems = allSchedule.filter(i => i.day == currentDay);
        dayItems.sort((a,b) => a.time.localeCompare(b.time));

        dayItems.forEach(item => {
            list.innerHTML += `
            <div class="card" onclick='openDetail(${JSON.stringify(item)})'>
                <div class="card-actions">
                    <span class="material-icons-outlined card-btn" onclick='editItem(${JSON.stringify(item)}); event.stopPropagation();'>edit</span>
                    <span class="material-icons-outlined card-btn del" onclick="delItem('schedule','${item.id}'); event.stopPropagation();">close</span>
                </div>
                <div class="card-time">${item.time}</div>
                <div class="card-title">${item.title}</div>
                <div class="card-sub"><span class="material-icons-round" style="font-size:14px;">notes</span> ${item.desc?item.desc.substring(0,15)+'...':'é»æ“ŠæŸ¥çœ‹è©³æƒ…'}</div>
            </div>`;
        });
    }

    function loadWallet(filter = 'ALL') {
        db.ref('expenses').on('value', snap => {
            const list = document.getElementById('wallet-list');
            list.innerHTML = ''; let total = 0;
            const data = snap.val();
            if(data) {
                Object.entries(data).forEach(([k, ex]) => {
                    if(filter !== 'ALL' && ex.payer !== filter) return;
                    const twd = Math.round(ex.amount * 0.22);
                    total += twd;
                    // è¨˜å¸³çš„ç·¨è¼¯æŒ‰éˆ•
                    list.innerHTML += `
                    <div class="exp-item">
                        <div>${ex.item}</div>
                        <div style="display:flex; align-items:center;">
                            <span style="font-weight:700; margin-right:10px;">$${twd.toLocaleString()}</span> 
                            <span style="font-size:0.7rem; background:#eee; padding:2px 5px; border-radius:4px;">${ex.payer}</span>
                            <div class="exp-btns">
                                <span class="material-icons-outlined card-btn" style="font-size:18px;" onclick='editExpense(${JSON.stringify({id:k, ...ex})})'>edit</span>
                                <span class="material-icons-outlined card-btn del" style="font-size:18px;" onclick="delItem('expenses','${k}')">delete</span>
                            </div>
                        </div>
                    </div>`;
                });
            }
            document.getElementById('wallet-total').innerText = '$'+total.toLocaleString();
        });
    }

    function filterWallet(who, el) {
        el.parentElement.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        el.classList.add('active');
        loadWallet(who);
    }

    function delItem(path, id) { 
        event.stopPropagation();
        if(confirm('åˆªé™¤?')) db.ref(path+'/'+id).remove(); 
    }

    function switchView(id, el) {
        document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
        el.classList.add('active');
    }
    
    // --- æ–°å¢ & ç·¨è¼¯ & é‡ç½® ---
    function openSheet() { 
        editingId = null;
        resetForms(); // é–‹å•Ÿæ™‚æ¸…ç©º
        document.getElementById('sheet-title').innerText = "æ–°å¢é …ç›®";
        document.getElementById('sheet-overlay').classList.add('show'); 
        document.getElementById('sheet-panel').classList.add('show'); 
    }
    
    // æ¸…ç©ºè¡¨å–®é‚è¼¯
    function resetForms() {
        document.getElementById('inp-title').value = '';
        document.getElementById('inp-desc').value = '';
        
        document.getElementById('tk-title').value = '';
        document.getElementById('tk-code').value = '';
        document.getElementById('tk-link').value = '';
        document.getElementById('tk-note').value = '';
        
        document.getElementById('exp-amt').value = '';
        document.getElementById('exp-item').value = '';
        document.getElementById('twd-preview').innerText = '0';
    }

    function editItem(item) {
        editingId = item.id;
        document.getElementById('sheet-title').innerText = "ç·¨è¼¯è¡Œç¨‹";
        setType('spot', document.querySelector('.type-btn'));
        document.getElementById('inp-day').value = item.day;
        document.getElementById('inp-time').value = item.time;
        document.getElementById('inp-title').value = item.title;
        document.getElementById('inp-desc').value = item.desc || "";
        document.getElementById('sheet-overlay').classList.add('show'); 
        document.getElementById('sheet-panel').classList.add('show'); 
    }

    function editTicket(item) {
        editingId = item.id;
        document.getElementById('sheet-title').innerText = "ç·¨è¼¯æ†‘è­‰";
        
        // åˆ‡æ›åˆ° Ticket Tab (æ‰‹å‹•æ¨¡æ“¬é»æ“Š)
        const tabs = document.querySelectorAll('.type-btn');
        setType('ticket', tabs[1]);

        document.getElementById('tk-title').value = item.title;
        document.getElementById('tk-code').value = item.code;
        document.getElementById('tk-link').value = item.link || "";
        document.getElementById('tk-note').value = item.note || "";
        
        document.getElementById('sheet-overlay').classList.add('show'); 
        document.getElementById('sheet-panel').classList.add('show'); 
    }

    function editExpense(item) {
        editingId = item.id;
        document.getElementById('sheet-title').innerText = "ç·¨è¼¯è¨˜å¸³";
        
        const tabs = document.querySelectorAll('.type-btn');
        setType('exp', tabs[2]);

        document.getElementById('exp-amt').value = item.amount;
        document.getElementById('exp-item').value = item.item;
        calcRate();
        setPayer(item.payer, document.querySelectorAll('#form-exp .filter-btn')[['Y','O','E','S'].indexOf(item.payer)]);
        
        document.getElementById('sheet-overlay').classList.add('show'); 
        document.getElementById('sheet-panel').classList.add('show'); 
    }

    function closeSheet() { document.getElementById('sheet-overlay').classList.remove('show'); document.getElementById('sheet-panel').classList.remove('show'); }
    
    function setType(t, el) {
        currentType = t;
        document.querySelectorAll('.type-btn').forEach(b=>b.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('form-spot').classList.add('hidden');
        document.getElementById('form-ticket').classList.add('hidden');
        document.getElementById('form-exp').classList.add('hidden');
        if(t==='spot') document.getElementById('form-spot').classList.remove('hidden');
        if(t==='ticket') document.getElementById('form-ticket').classList.remove('hidden');
        if(t==='exp') document.getElementById('form-exp').classList.remove('hidden');
    }

    function setPayer(p, el) { 
        selectedPayer = p; 
        el.parentElement.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        el.classList.add('active');
    }

    function calcRate() { 
        const val = document.getElementById('exp-amt').value;
        const twd = Math.round(val * 0.22);
        document.getElementById('twd-preview').innerText = twd.toLocaleString(); 
    }

    function saveItem() {
        if(currentType === 'spot') {
            const data = {
                day: document.getElementById('inp-day').value,
                time: document.getElementById('inp-time').value,
                title: document.getElementById('inp-title').value,
                desc: document.getElementById('inp-desc').value
            };
            if(editingId) db.ref('schedule/' + editingId).update(data);
            else db.ref('schedule').push(data);
        } else if(currentType === 'ticket') {
            const data = {
                title: document.getElementById('tk-title').value,
                code: document.getElementById('tk-code').value,
                link: document.getElementById('tk-link').value,
                note: document.getElementById('tk-note').value
            };
            if(editingId) db.ref('tickets/' + editingId).update(data);
            else db.ref('tickets').push(data);
        } else {
            const data = {
                amount: document.getElementById('exp-amt').value,
                item: document.getElementById('exp-item').value,
                payer: selectedPayer
            };
            if(editingId) db.ref('expenses/' + editingId).update(data);
            else db.ref('expenses').push(data);
        }
        closeSheet();
        resetForms(); // å„²å­˜å¾Œæ¸…ç©º
    }

    // è©³æƒ… & ç…§ç‰‡
    function openDetail(item) {
        currentDetailId = item.id;
        document.getElementById('dt-title').innerText = item.title;
        document.getElementById('dt-desc').innerText = item.desc || 'ç„¡ä»‹ç´¹';
        document.getElementById('detail-modal').classList.add('show');
        const cover = document.getElementById('dt-cover');
        const text = document.getElementById('dt-cover-text');
        if(item.img) {
            cover.style.backgroundImage = `url(${item.img})`;
            text.innerText = "";
        } else {
            cover.style.backgroundImage = "none";
            text.innerText = "é»æ“Šæ–°å¢ç…§ç‰‡ (PHOTO)";
        }
    }
    
    function closeDetail() { document.getElementById('detail-modal').classList.remove('show'); }
    
    function triggerPhotoUpload() { document.getElementById('file-input').click(); }
    
    function handlePhotoUpload(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const MAX_WIDTH = 800;
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    if(currentDetailId) {
                        db.ref('schedule/' + currentDetailId).update({ img: dataUrl });
                        document.getElementById('dt-cover').style.backgroundImage = `url(${dataUrl})`;
                        document.getElementById('dt-cover-text').innerText = "";
                    }
                }
            }
            reader.readAsDataURL(file);
        }
    }

    // AI & Copy
    function toggleAI(show) { 
        const el = document.getElementById('ai-modal');
        if(show) el.classList.add('show'); else el.classList.remove('show');
    }

    function copySchedule() {
        let dayItems = allSchedule.filter(i => i.day == currentDay);
        if(dayItems.length === 0) return alert('æœ¬æ—¥ç„¡è¡Œç¨‹å¯è¤‡è£½');
        
        let text = `Day ${currentDay} æ±äº¬è¡Œç¨‹ï¼š\n`;
        dayItems.sort((a,b) => a.time.localeCompare(b.time));
        dayItems.forEach(i => {
            text += `- ${i.time} ${i.title}\n`;
        });
        text += "\nè«‹å¹«æˆ‘æª¢æŸ¥é€™å€‹è¡Œç¨‹é †ä¸é †ï¼Ÿæœ‰ç„¡å»ºè­°ï¼Ÿ";
        
        navigator.clipboard.writeText(text).then(() => {
            alert('å·²è¤‡è£½ï¼è«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å•Ÿ ChatGPT æˆ– Perplexity è²¼ä¸Šè©¢å•ã€‚');
        });
    }

    if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
</script>
</body>
</html>