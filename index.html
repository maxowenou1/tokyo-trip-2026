<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tokyo Trip App</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#F9F9F7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Round|Material+Icons+Outlined" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@500;700&family=Lato:wght@400;700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #F9F9F7;
            --card: #FFFFFF;
            --text-main: #1A1A1A;
            --text-sub: #666666;
            --accent: #C5A059; 
            --red: #D9534F;
            --shadow: 0 4px 20px rgba(0,0,0,0.06);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        body {
            background-color: #EFEFEF; /* é›»è…¦ç‰ˆèƒŒæ™¯ç° */
            margin: 0; padding: 0;
            font-family: 'Lato', 'Noto Serif TC', sans-serif;
            color: var(--text-main);
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            display: flex; justify-content: center; /* é›»è…¦ç‰ˆç½®ä¸­ */
            min-height: 100vh;
        }

        /* --- æ‰‹æ©Ÿæ¨¡æ“¬å®¹å™¨ (é—œéµï¼è®“é›»è…¦çœ‹ä¹Ÿåƒæ‰‹æ©Ÿ) --- */
        #app-container {
            width: 100%; max-width: 430px; /* é–å®šæ‰‹æ©Ÿå¯¬åº¦ */
            background-color: var(--bg);
            min-height: 100vh;
            position: relative;
            box-shadow: 0 0 30px rgba(0,0,0,0.1);
            padding-bottom: calc(90px + var(--safe-bottom));
            overflow-x: hidden;
        }

        /* --- Header --- */
        header {
            padding: max(20px, env(safe-area-inset-top)) 20px 10px;
            background: var(--bg); position: sticky; top: 0; z-index: 50;
            text-align: center;
        }
        .trip-title { font-size: 1.4rem; font-weight: 700; letter-spacing: 2px; }
        .trip-year { font-size: 0.75rem; border: 1px solid #ccc; border-radius: 20px; padding: 2px 8px; display: inline-block; color: #888; margin-left: 5px; }

        /* --- View 1: è¡Œç¨‹è¡¨ (Day Scroll) --- */
        .date-scroll {
            display: flex; gap: 10px; overflow-x: auto; padding: 10px 20px;
            scrollbar-width: none;
        }
        .date-scroll::-webkit-scrollbar { display: none; }
        .date-item {
            min-width: 50px; height: 65px; background: #fff; border-radius: 30px;
            border: 1px solid #eee; display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: var(--shadow); transition: 0.2s;
        }
        .date-item.active { background: var(--text-main); color: #fff; transform: translateY(-3px); }
        .date-day { font-size: 0.6rem; letter-spacing: 1px; margin-bottom: 2px; }
        .date-num { font-size: 1.2rem; font-weight: 700; font-family: 'Inter'; }

        .timeline-box { padding: 20px; }
        .card {
            background: #fff; border-radius: 12px; padding: 20px; margin-bottom: 20px;
            box-shadow: var(--shadow); position: relative; border: 1px solid rgba(0,0,0,0.03);
            cursor: pointer; transition: 0.2s;
        }
        .card:active { transform: scale(0.98); }
        .card-time { font-family: 'Inter'; font-weight: 600; font-size: 1.1rem; color: var(--accent); margin-bottom: 5px; }
        .card-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 5px; }
        .card-sub { font-size: 0.8rem; color: #999; display: flex; align-items: center; gap: 4px;}

        /* --- View 2: è¨‚ä½æ†‘è­‰ (Booking) - ç¨ç«‹åŠŸèƒ½ --- */
        .booking-list { padding: 20px; }
        .booking-card {
            background: #fff; border-radius: 12px; overflow: hidden; margin-bottom: 20px;
            box-shadow: var(--shadow); border: 1px solid #eee;
        }
        .bk-header { padding: 15px; background: #FDFDFD; border-bottom: 1px dashed #ddd; display: flex; justify-content: space-between; align-items: center; }
        .bk-type { font-size: 0.7rem; font-weight: 700; letter-spacing: 1px; color: #aaa; text-transform: uppercase; }
        .bk-body { padding: 20px; }
        .bk-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 15px; }
        .bk-code-label { font-size: 0.7rem; color: #aaa; margin-bottom: 5px; display: block; }
        .bk-code { font-size: 1.5rem; font-family: 'Inter'; font-weight: 700; letter-spacing: 2px; color: var(--text-main); }
        .bk-actions { padding: 15px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; }
        .icon-btn { color: #666; cursor: pointer; }

        /* --- View 3: è³‡è¨Šé  (Info) - å¾©åˆ»ç‰ˆ --- */
        .map-preview {
            margin: 20px; height: 200px; background: #eee; border-radius: 12px; 
            position: relative; overflow: hidden; border: 1px solid #ddd;
        }
        .map-img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; }
        .map-btn {
            position: absolute; bottom: 15px; left: 15px; right: 15px;
            background: #fff; padding: 10px; text-align: center; border-radius: 8px;
            font-weight: 700; font-size: 0.9rem; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            color: var(--text-main); text-decoration: none; display: block;
        }
        
        .vjw-card {
            margin: 0 20px 20px; background: linear-gradient(135deg, #1a1a1a, #333);
            border-radius: 12px; padding: 25px; color: #fff; position: relative;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .vjw-tag { background: var(--red); font-size: 0.6rem; padding: 3px 6px; border-radius: 4px; display: inline-block; margin-bottom: 8px; }
        .vjw-title { font-size: 1.4rem; font-weight: 700; font-family: 'Serif'; margin-bottom: 5px; }
        .vjw-sub { font-size: 0.8rem; opacity: 0.7; }
        .vjw-icon { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); font-size: 32px; opacity: 0.5; }

        .emergency-row { display: flex; gap: 15px; margin: 0 20px 20px; }
        .em-box { flex: 1; background: #fff; padding: 20px; text-align: center; border-radius: 12px; box-shadow: var(--shadow); }
        .em-num { font-size: 2.2rem; font-weight: 700; color: var(--red); font-family: 'Inter'; display: block; margin-top: 5px; }
        .em-label { font-size: 0.7rem; color: #999; letter-spacing: 1px; }

        .hotline-card { margin: 0 20px; background: #fff; padding: 20px; border-radius: 12px; box-shadow: var(--shadow); position: relative; }
        .hotline-num { font-size: 1.6rem; font-weight: 700; color: #333; margin: 5px 0; font-family: 'Inter'; }

        /* --- å°éŠè©³æƒ…é  (Detail Modal) --- */
        .detail-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 200; display: none;
            justify-content: center; align-items: flex-end; /* æ‰‹æ©Ÿç‰ˆå¾ä¸‹é¢å‡ºä¾† */
        }
        .detail-modal.show { display: flex; }
        
        .detail-sheet {
            width: 100%; max-width: 430px; height: 90vh; background: #fff;
            border-radius: 20px 20px 0 0; overflow-y: auto; position: relative;
            animation: slideUp 0.3s;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .detail-cover { height: 200px; background: #eee; position: relative; }
        .detail-close { 
            position: absolute; top: 15px; right: 15px; width: 35px; height: 35px; 
            background: rgba(0,0,0,0.5); border-radius: 50%; color: #fff; 
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        
        .detail-content { padding: 25px; }
        .detail-tag { font-size: 0.7rem; letter-spacing: 2px; color: var(--accent); text-transform: uppercase; font-weight: 700; display: block; margin-bottom: 10px; }
        .detail-title { font-size: 1.8rem; font-weight: 700; margin-bottom: 10px; line-height: 1.3; }
        .detail-info { font-size: 0.9rem; color: #666; margin-bottom: 20px; display: flex; gap: 15px; }
        
        .story-box { border-left: 3px solid #eee; padding-left: 15px; margin-bottom: 30px; }
        .story-p { font-size: 1rem; line-height: 1.8; color: #444; margin-bottom: 15px; }
        .story-label { font-weight: 700; margin-bottom: 5px; font-size: 0.9rem; }

        .ai-ask-btn {
            width: 100%; padding: 15px; background: #F0F4F8; color: #333;
            border: none; border-radius: 12px; font-weight: 700; font-size: 0.9rem;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            cursor: pointer; margin-top: 20px;
        }
        .ai-result { 
            background: #F0F4F8; padding: 15px; border-radius: 12px; margin-top: 15px; 
            font-size: 0.9rem; line-height: 1.6; display: none; 
        }

        /* --- åº•éƒ¨å°èˆª --- */
        .nav-bar {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            border-top: 1px solid rgba(0,0,0,0.05); padding: 10px 0 calc(10px + var(--safe-bottom));
            display: flex; justify-content: space-around; z-index: 100;
        }
        .nav-item { text-align: center; color: #ccc; cursor: pointer; flex: 1; }
        .nav-item.active { color: var(--text-main); }
        .nav-icon { font-size: 24px; display: block; margin-bottom: 2px; }
        .nav-label { font-size: 0.6rem; font-weight: 700; letter-spacing: 1px; }

        /* æ–°å¢æŒ‰éˆ• (FAB) */
        .fab {
            position: absolute; bottom: 90px; right: 20px;
            width: 55px; height: 55px; background: var(--text-main); border-radius: 50%;
            color: #fff; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); cursor: pointer; z-index: 90;
        }

        /* æ–°å¢é¢æ¿ */
        .sheet-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; display: none; }
        .sheet-overlay.show { display: flex; justify-content: center; align-items: flex-end; }
        .sheet { width: 100%; max-width: 430px; background: #fff; border-radius: 20px 20px 0 0; padding: 25px; box-sizing: border-box; transform: translateY(100%); transition: 0.3s; padding-bottom: calc(30px + var(--safe-bottom)); }
        .sheet.show { transform: translateY(0); }
        
        .inp { width: 100%; padding: 14px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 12px; font-size: 1rem; box-sizing: border-box; background: #f9f9f9; }
        .type-row { display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; }
        .type-btn { padding: 8px 16px; border: 1px solid #eee; border-radius: 20px; font-size: 0.9rem; white-space: nowrap; }
        .type-btn.active { background: var(--text-main); color: #fff; }
        .btn-main { width: 100%; padding: 15px; background: var(--text-main); color: #fff; border: none; border-radius: 12px; font-weight: 700; font-size: 1rem; }

        .view { display: none; }
        .view.active { display: block; }
    </style>
</head>
<body>

<div id="app-container">
    
    <div id="view-trip" class="view active">
        <header>
            <div class="trip-title">TOKYO TRIP <span class="trip-year">2026</span></div>
        </header>
        
        <div class="date-scroll" id="date-list">
            </div>

        <div class="timeline-box" id="itinerary-list">
            </div>
    </div>

    <div id="view-booking" class="view">
        <header>
            <div class="trip-title">BOOKINGS</div>
            <div style="font-size:0.8rem; color:#888;">è¨‚ä½ä»£ç¢¼èˆ‡æ†‘è­‰é›†ä¸­å€</div>
        </header>
        <div class="booking-list" id="booking-list">
            </div>
    </div>

    <div id="view-info" class="view">
        <header>
            <div class="trip-title">INFO</div>
        </header>
        
        <div class="map-preview">
            <img src="https://maps.googleapis.com/maps/api/staticmap?center=Tokyo&zoom=10&size=600x300&key=YOUR_KEY_OR_MOCK" class="map-img" style="background:#ddd;">
            <a href="https://www.google.com/maps/place/Tokyo" target="_blank" class="map-btn">
                <span class="material-icons-outlined" style="vertical-align:middle; font-size:18px;">map</span> é–‹å•Ÿ Google Maps å°èˆª
            </a>
        </div>

        <div class="vjw-card" onclick="window.open('https://www.vjw.digital.go.jp/','_blank')">
            <span class="vjw-tag">MUST HAVE</span>
            <div class="vjw-title">Visit Japan Web</div>
            <div class="vjw-sub">å…¥å¢ƒå¯©æŸ¥ & æµ·é—œç”³å ± QR Code</div>
            <span class="material-icons-outlined vjw-icon">qr_code_2</span>
        </div>

        <div class="emergency-row">
            <div class="em-box">
                <span class="em-label">è­¦å¯Ÿ (POLICE)</span>
                <span class="em-num">110</span>
            </div>
            <div class="em-box">
                <span class="em-label">æ•‘è­·/ç«è­¦</span>
                <span class="em-num">119</span>
            </div>
        </div>

        <div class="hotline-card">
            <div style="font-weight:700;">è¨ªæ—¥å¤–åœ‹äººé†«ç™‚ç†±ç·š</div>
            <div class="hotline-num">050-3816-2787</div>
            <div style="font-size:0.8rem; color:#888;">24å°æ™‚å°æ‡‰ (è‹±/ä¸­/éŸ“)</div>
            <div style="position:absolute; right:20px; top:50%; transform:translateY(-50%); background:#333; color:#fff; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center;">
                <span class="material-icons-round">call</span>
            </div>
        </div>
    </div>

    <div id="view-wallet" class="view">
        <header><div class="trip-title">WALLET</div></header>
        <div style="text-align:center; padding:30px;">
            <div style="color:#888;">ç¸½æ”¯å‡º (TWD)</div>
            <div style="font-size:2.5rem; font-weight:700;" id="wallet-total">$0</div>
        </div>
        <div id="wallet-list" style="padding:0 20px;"></div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchView('view-trip', this)">
            <span class="material-icons-round nav-icon">map</span>
            <span class="nav-label">è¡Œç¨‹</span>
        </div>
        <div class="nav-item" onclick="switchView('view-booking', this)">
            <span class="material-icons-round nav-icon">confirmation_number</span>
            <span class="nav-label">æ†‘è­‰</span>
        </div>
        <div class="nav-item" onclick="switchView('view-info', this)">
            <span class="material-icons-round nav-icon">info</span>
            <span class="nav-label">è³‡è¨Š</span>
        </div>
        <div class="nav-item" onclick="switchView('view-wallet', this)">
            <span class="material-icons-round nav-icon">account_balance_wallet</span>
            <span class="nav-label">è¨˜å¸³</span>
        </div>
    </div>

    <div class="fab" onclick="openSheet()">
        <span class="material-icons-round" style="font-size:28px;">add</span>
    </div>

    <div class="detail-modal" id="detail-modal">
        <div class="detail-sheet">
            <div class="detail-close" onclick="closeDetail()"><span class="material-icons-round">close</span></div>
            <div class="detail-cover" id="dt-cover">
                <div style="width:100%; height:100%; background:#ddd; display:flex; align-items:center; justify-content:center; color:#999;">PHOTO</div>
            </div>
            <div class="detail-content">
                <span class="detail-tag" id="dt-tag">FOOD</span>
                <div class="detail-title" id="dt-title">åº—åè¼‰å…¥ä¸­...</div>
                <div class="detail-info">
                    <span id="dt-time">12:00</span>
                    <span>|</span>
                    <span>æ±äº¬</span>
                </div>

                <div class="story-box">
                    <div class="story-label">ã€ä»‹ç´¹èˆ‡æ”»ç•¥ã€‘</div>
                    <div class="story-p" id="dt-desc">
                        é€™è£¡æœƒé¡¯ç¤ºè©³ç´°çš„ä»‹ç´¹ã€‚å¦‚æœæ²’æœ‰å¡«å¯«ï¼ŒAI å°éŠå¯ä»¥å¹«ä½ ç”Ÿæˆã€‚
                    </div>
                    <div class="story-label" id="dt-code-label" style="display:none;">ã€è¨‚ä½/ä»£ç¢¼ã€‘</div>
                    <div class="story-p" id="dt-code" style="font-family:'Inter'; font-weight:700; font-size:1.2rem; display:none;"></div>
                </div>

                <button class="ai-ask-btn" onclick="askAI()">
                    <span class="material-icons-round" style="color:var(--accent);">smart_toy</span>
                    Ask AI Guide (è©¢å• AI å°éŠ)
                </button>
                <div class="ai-result" id="ai-result">
                    æ­£åœ¨åˆ†ææ­¤åœ°é»çš„è³‡è¨Š...<br>æ¨è–¦èœè‰²ï¼š...<br>æ³¨æ„äº‹é …ï¼š...
                </div>
            </div>
        </div>
    </div>

    <div class="sheet-overlay" id="sheet-overlay" onclick="closeSheet()">
        <div class="sheet" onclick="event.stopPropagation()">
            <h3 style="margin-top:0;">æ–°å¢é …ç›®</h3>
            <div class="type-row">
                <div class="type-btn active" onclick="setType('spot', this)">ğŸ“ æ™¯é»</div>
                <div class="type-btn" onclick="setType('food', this)">ğŸ´ é¤å»³</div>
                <div class="type-btn" onclick="setType('hotel', this)">ğŸ¨ ä½å®¿</div>
                <div class="type-btn" onclick="setType('trans', this)">ğŸš• äº¤é€š</div>
                <div class="type-btn" onclick="setType('exp', this)">ğŸ’° è¨˜å¸³</div>
            </div>

            <div id="form-common">
                <select id="inp-day" class="inp"></select>
                <input type="time" id="inp-time" class="inp" value="10:00">
                <input type="text" id="inp-title" class="inp" placeholder="åç¨±">
                <textarea id="inp-desc" class="inp" rows="3" placeholder="ä»‹ç´¹ / æ”»ç•¥ / ç­†è¨˜ (æœƒé¡¯ç¤ºåœ¨å°éŠé )"></textarea>
                <input type="text" id="inp-code" class="inp" placeholder="è¨‚ä½ä»£ç¢¼ / ç¢ºèªè™Ÿ (æœƒé¡¯ç¤ºåœ¨æ†‘è­‰å€)">
            </div>

            <div id="form-exp" style="display:none;">
                <input type="number" id="inp-amt" class="inp" placeholder="é‡‘é¡ (JPY)">
                <input type="text" id="inp-item" class="inp" placeholder="é …ç›®">
            </div>

            <button class="btn-main" onclick="saveItem()">å„²å­˜</button>
        </div>
    </div>

</div>

<script>
    // âœ… é‡‘é‘°
    const firebaseConfig = {
        apiKey: "AIzaSyCbrzyXFiRYxGyt6crsRTQNQ5lfZnz65kA",
        authDomain: "tokyo-trip-2026-acfe6.firebaseapp.com",
        databaseURL: "https://tokyo-trip-2026-acfe6-default-rtdb.firebaseio.com",
        projectId: "tokyo-trip-2026-acfe6",
        storageBucket: "tokyo-trip-2026-acfe6.firebasestorage.app",
        messagingSenderId: "345730464055",
        appId: "1:345730464055:web:662b4c0391f893828c42b2",
        measurementId: "G-FKTG3ERB29"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentDay = 1;
    let currentType = 'spot';

    init();

    function init() {
        // ç”Ÿæˆ 10 å¤©
        const dateList = document.getElementById('date-list');
        const daySel = document.getElementById('inp-day');
        for(let i=1; i<=10; i++) {
            dateList.innerHTML += `<div class="date-item ${i===1?'active':''}" onclick="setDay(${i}, this)">
                <span class="date-day">DAY</span><span class="date-num">${i}</span>
            </div>`;
            daySel.innerHTML += `<option value="${i}">Day ${i}</option>`;
        }
        loadData();
    }

    function setDay(d, el) {
        currentDay = d;
        document.querySelectorAll('.date-item').forEach(e=>e.classList.remove('active'));
        el.classList.add('active');
        loadData();
    }

    function loadData() {
        // 1. è¼‰å…¥è¡Œç¨‹
        db.ref('schedule').on('value', snap => {
            const list = document.getElementById('itinerary-list');
            const bkList = document.getElementById('booking-list');
            list.innerHTML = ''; bkList.innerHTML = '';
            
            const data = snap.val();
            if(data) {
                let arr = [];
                for(let k in data) arr.push({id:k, ...data[k]});
                arr.sort((a,b) => a.time.localeCompare(b.time));

                arr.forEach(item => {
                    // A. è¡Œç¨‹å¡ç‰‡ (åªé¡¯ç¤ºåœ¨è©²å¤©)
                    if(item.day == currentDay) {
                        list.innerHTML += `
                        <div class="card" onclick='openDetail(${JSON.stringify(item)})'>
                            <div class="card-time">${item.time}</div>
                            <div class="card-title">${item.title}</div>
                            <div class="card-sub">
                                <span class="material-icons-round" style="font-size:14px;">place</span>
                                ${item.type.toUpperCase()}
                            </div>
                        </div>`;
                    }

                    // B. æ†‘è­‰å¡ç‰‡ (é¡¯ç¤ºåœ¨æ†‘è­‰å€ï¼Œå¦‚æœæœ‰ä»£ç¢¼)
                    if(item.code) {
                        bkList.innerHTML += `
                        <div class="booking-card">
                            <div class="bk-header">
                                <span class="bk-type">${item.type}</span>
                                <span style="font-size:0.8rem; color:#888;">Day ${item.day}</span>
                            </div>
                            <div class="bk-body">
                                <div class="bk-title">${item.title}</div>
                                <span class="bk-code-label">CONFIRMATION NO.</span>
                                <div class="bk-code">${item.code}</div>
                            </div>
                            <div class="bk-actions">
                                <span class="material-icons-outlined icon-btn">content_copy</span>
                            </div>
                        </div>`;
                    }
                });
            }
        });

        // 2. è¼‰å…¥è¨˜å¸³
        db.ref('expenses').on('value', snap => {
            const list = document.getElementById('wallet-list');
            list.innerHTML = ''; let total = 0;
            const data = snap.val();
            if(data) {
                Object.values(data).forEach(ex => {
                    const twd = Math.round(ex.amount * 0.22);
                    total += twd;
                    list.innerHTML += `<div style="display:flex; justify-content:space-between; padding:15px 0; border-bottom:1px solid #eee;">
                        <span>${ex.item}</span>
                        <span style="font-weight:700;">$${twd}</span>
                    </div>`;
                });
            }
            document.getElementById('wallet-total').innerText = '$'+total.toLocaleString();
        });
    }

    // --- è©³æƒ…èˆ‡ AI ---
    function openDetail(item) {
        document.getElementById('dt-tag').innerText = item.type;
        document.getElementById('dt-title').innerText = item.title;
        document.getElementById('dt-time').innerText = item.time;
        document.getElementById('dt-desc').innerText = item.desc || "æš«ç„¡è©³ç´°ä»‹ç´¹ï¼Œé»æ“Šä¸‹æ–¹æŒ‰éˆ•è©¢å• AIã€‚";
        
        if(item.code) {
            document.getElementById('dt-code-label').style.display='block';
            document.getElementById('dt-code').style.display='block';
            document.getElementById('dt-code').innerText = item.code;
        } else {
            document.getElementById('dt-code-label').style.display='none';
            document.getElementById('dt-code').style.display='none';
        }
        
        document.getElementById('ai-result').style.display = 'none';
        document.getElementById('detail-modal').classList.add('show');
    }
    function closeDetail() { document.getElementById('detail-modal').classList.remove('show'); }
    
    function askAI() {
        const res = document.getElementById('ai-result');
        res.style.display = 'block';
        res.innerHTML = 'AI æ­£åœ¨æŸ¥è©¢è³‡æ–™åº«...';
        setTimeout(() => {
            res.innerHTML = `
            <strong>ã€AI å°éŠåˆ†æã€‘</strong><br>
            é€™æ˜¯ä¸€å€‹éå¸¸æ£’çš„é¸æ“‡ï¼<br>
            â˜… <strong>å¿…åƒ/äº®é»ï¼š</strong> ç¶²å‹æ¨è–¦é€™è£¡çš„ç‰¹è‰²é«”é©—ã€‚<br>
            â˜… <strong>å°æé†’ï¼š</strong> å»ºè­°æå‰ 10 åˆ†é˜æŠµé”ã€‚<br>
            ç¥æ‚¨åœ¨ ${document.getElementById('dt-title').innerText} ç©å¾—æ„‰å¿«ï¼
            `;
        }, 1000);
    }

    // --- æ“ä½œ ---
    function switchView(id, el) {
        document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
        el.classList.add('active');
    }
    function openSheet() { document.getElementById('sheet-overlay').classList.add('show'); document.getElementById('sheet-overlay').style.display='flex'; }
    function closeSheet() { document.getElementById('sheet-overlay').classList.remove('show'); setTimeout(()=>document.getElementById('sheet-overlay').style.display='none', 300);}
    
    function setType(t, el) {
        currentType = t;
        document.querySelectorAll('.type-btn').forEach(b=>b.classList.remove('active'));
        el.classList.add('active');
        if(t==='exp') {
            document.getElementById('form-common').style.display='none';
            document.getElementById('form-exp').style.display='block';
        } else {
            document.getElementById('form-common').style.display='block';
            document.getElementById('form-exp').style.display='none';
        }
    }

    function saveItem() {
        if(currentType === 'exp') {
            db.ref('expenses').push({
                amount: document.getElementById('inp-amt').value,
                item: document.getElementById('inp-item').value
            });
        } else {
            db.ref('schedule').push({
                day: document.getElementById('inp-day').value,
                time: document.getElementById('inp-time').value,
                title: document.getElementById('inp-title').value,
                desc: document.getElementById('inp-desc').value,
                code: document.getElementById('inp-code').value,
                type: currentType
            });
        }
        closeSheet();
    }

    if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
</script>
</body>
</html>