<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tokyo OS v7</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f0f1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&family=Noto+Serif+TC:wght@500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-glass: rgba(20, 20, 35, 0.75);
            --border-glass: rgba(255, 255, 255, 0.12);
            --text-main: #ffffff;
            --text-sub: #a0a0b0;
            --accent: #ff9f43; /* Êù±‰∫¨ÈêµÂ°îÊ©òÈáë */
            --safe-bottom: env(safe-area-inset-bottom);
        }

        body {
            /* ‰Ω†ÁöÑÊù±‰∫¨ÈêµÂ°îÂ§úÊôØÂúñ */
            background: url('https://images.unsplash.com/photo-1513407030348-c983a97b98d8?q=80&w=1000&auto=format&fit=crop') no-repeat center center fixed;
            background-size: cover;
            font-family: 'Inter', sans-serif;
            margin: 0; padding: 0;
            color: var(--text-main);
            padding-bottom: calc(100px + var(--safe-bottom));
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        /* ËÉåÊôØË™øÊöó */
        body::before {
            content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 5, 15, 0.5); backdrop-filter: blur(3px); z-index: -1;
        }

        /* --- Â§©Ê∞£ËàáÊ®ôÈ°åÂçÄ --- */
        header {
            padding: max(20px, env(safe-area-inset-top)) 20px 10px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
        }
        .header-top { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 15px; }
        .trip-title { font-size: 1.8rem; font-family: 'Noto Serif TC', serif; font-weight: 700; text-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        .trip-dates { font-size: 0.8rem; color: var(--text-sub); letter-spacing: 1px; }

        /* Â§©Ê∞£Ê©´ÂêëÊç≤Ëª∏ */
        .weather-scroll {
            display: flex; gap: 12px; overflow-x: auto; padding-bottom: 10px;
            scrollbar-width: none;
        }
        .weather-scroll::-webkit-scrollbar { display: none; }
        
        .weather-card {
            min-width: 70px; padding: 10px;
            background: var(--bg-glass); border: 1px solid var(--border-glass);
            border-radius: 16px; text-align: center;
            backdrop-filter: blur(10px);
        }
        .w-day { font-size: 0.7rem; color: var(--text-sub); margin-bottom: 5px; }
        .w-icon { font-size: 24px; margin-bottom: 5px; }
        .w-temp { font-size: 0.9rem; font-weight: 700; }

        /* --- Êó•ÊúüÈÅ∏ÂñÆ --- */
        .date-bar {
            position: sticky; top: 0; z-index: 50;
            background: rgba(15, 15, 26, 0.85); backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-glass);
            display: flex; gap: 10px; overflow-x: auto; padding: 12px 20px;
            scrollbar-width: none;
        }
        .date-bar::-webkit-scrollbar { display: none; }
        
        .date-chip {
            padding: 8px 16px; border-radius: 20px;
            background: rgba(255,255,255,0.05); border: 1px solid transparent;
            color: var(--text-sub); font-size: 0.9rem; white-space: nowrap;
            transition: 0.2s;
        }
        .date-chip.active {
            background: var(--text-main); color: #000; font-weight: 700;
            box-shadow: 0 0 15px rgba(255,255,255,0.2);
        }

        /* --- Ë°åÁ®ãÂç°Áâá --- */
        .container { padding: 20px; }
        
        .card {
            background: var(--bg-glass);
            border: 1px solid var(--border-glass);
            border-radius: 20px; padding: 18px; margin-bottom: 16px;
            display: flex; gap: 15px; align-items: flex-start;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        .time-badge {
            background: rgba(255,255,255,0.1); padding: 6px 10px;
            border-radius: 8px; font-weight: 700; font-size: 0.9rem;
            color: var(--accent); white-space: nowrap;
        }
        .card-content { flex: 1; }
        .card-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 4px; line-height: 1.4; }
        .card-note { font-size: 0.85rem; color: var(--text-sub); margin-bottom: 10px; }
        .card-actions { display: flex; gap: 10px; }
        .btn-sm {
            padding: 6px 12px; border-radius: 8px; font-size: 0.8rem;
            background: rgba(255,255,255,0.08); color: #fff; text-decoration: none;
            display: flex; align-items: center; gap: 4px; border: 1px solid var(--border-glass);
        }

        /* --- Ë®òÂ∏≥Á∏ΩË¶Ω --- */
        .wallet-card {
            background: linear-gradient(135deg, #2d3436, #000000);
            padding: 25px; border-radius: 24px; text-align: center;
            border: 1px solid var(--border-glass); margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        }

        /* --- Â∫ïÈÉ®Â∞éËà™ & FAB --- */
        .nav-bar {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 85%; max-width: 350px;
            background: rgba(30, 30, 40, 0.9); backdrop-filter: blur(20px);
            border: 1px solid var(--border-glass);
            border-radius: 30px; height: 65px;
            display: flex; justify-content: space-around; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 90;
        }
        .nav-btn { color: #666; font-size: 28px; transition: 0.2s; }
        .nav-btn.active { color: #fff; text-shadow: 0 0 10px rgba(255,255,255,0.5); }
        
        .fab-add {
            width: 55px; height: 55px; background: var(--text-main); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: #000; box-shadow: 0 0 20px rgba(255,255,255,0.3);
            position: relative; top: -20px; border: 4px solid rgba(30,30,40,1);
        }

        /* --- iOS Style Bottom Sheet (ÊªëÂãïÈù¢Êùø) --- */
        .sheet-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 100; opacity: 0;
            pointer-events: none; transition: 0.3s;
        }
        .sheet-overlay.show { opacity: 1; pointer-events: auto; }
        
        .bottom-sheet {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #1e1e24; /* Ê∑±ÁÅ∞Â∫ïËâ≤ */
            border-radius: 24px 24px 0 0;
            padding: 25px; padding-bottom: calc(30px + var(--safe-bottom));
            box-sizing: border-box; transform: translateY(100%);
            transition: 0.4s cubic-bezier(0.2, 0.9, 0.3, 1);
            z-index: 101; border-top: 1px solid var(--border-glass);
        }
        .sheet-overlay.show .bottom-sheet { transform: translateY(0); }

        .sheet-handle {
            width: 40px; height: 5px; background: #444;
            border-radius: 3px; margin: 0 auto 20px;
        }
        
        /* Ë°®ÂñÆÁæéÂåñ */
        .input-lg {
            width: 100%; background: #2b2b36; border: none;
            padding: 15px; border-radius: 12px; color: #fff;
            font-size: 1.1rem; margin-bottom: 12px; outline: none;
        }
        .input-lg::placeholder { color: #666; }
        
        .type-toggle {
            display: flex; background: #2b2b36; padding: 4px;
            border-radius: 12px; margin-bottom: 20px;
        }
        .type-btn {
            flex: 1; padding: 10px; border-radius: 10px; text-align: center;
            font-weight: 700; font-size: 0.9rem; color: #888; transition: 0.2s;
        }
        .type-btn.active { background: #fff; color: #000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }

        .big-btn {
            width: 100%; background: var(--accent); color: #000;
            padding: 16px; border-radius: 14px; font-weight: 700; font-size: 1.1rem;
            border: none; margin-top: 10px;
        }

        .payer-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .payer-chip {
            flex: 1; padding: 12px; background: #2b2b36; border-radius: 12px;
            text-align: center; color: #888; border: 1px solid transparent;
        }
        .payer-chip.active { border-color: var(--accent); color: var(--accent); background: rgba(255, 159, 67, 0.1); }

        .view { display: none; }
        .view.active { display: block; }
    </style>
</head>
<body>

    <header>
        <div class="header-top">
            <div>
                <div class="trip-title">Tokyo Trip</div>
                <div class="trip-dates">2026.09.13 - 09.22</div>
            </div>
        </div>
        <div class="weather-scroll" id="weather-widget">
            <div style="color:#666; font-size:0.8rem;">ËºâÂÖ•Êù±‰∫¨Â§©Ê∞£‰∏≠...</div>
        </div>
    </header>

    <div id="view-trip" class="view active">
        <div class="date-bar">
            <div class="date-chip active" onclick="setDay(1)">Day 1</div>
            <div class="date-chip" onclick="setDay(2)">Day 2</div>
            <div class="date-chip" onclick="setDay(3)">Day 3</div>
            <div class="date-chip" onclick="setDay(4)">Day 4</div>
            <div class="date-chip" onclick="setDay(5)">Day 5</div>
        </div>
        <div class="container" id="itinerary-list"></div>
    </div>

    <div id="view-wallet" class="view">
        <div class="container">
            <div class="wallet-card">
                <div style="color:#aaa; margin-bottom:5px;">Á∏ΩÊîØÂá∫ (TWD)</div>
                <div style="font-size:3rem; font-weight:700;" id="display-total">$0</div>
                <div style="margin-top:15px; display:flex; justify-content:center; gap:8px;">
                    <div class="btn-sm" onclick="filterWallet('ALL')">ÂÖ®ÈÉ®</div>
                    <div class="btn-sm" onclick="filterWallet('M')">Êàë‰ªò</div>
                    <div class="btn-sm" onclick="filterWallet('W')">Â•π‰ªò</div>
                </div>
            </div>
            <div id="expense-list"></div>
        </div>
    </div>

    <div class="nav-bar">
        <span class="material-icons-round nav-btn active" onclick="switchView('view-trip', this)">map</span>
        <div class="fab-add" onclick="openSheet()">
            <span class="material-icons-round" style="font-size:32px;">add</span>
        </div>
        <span class="material-icons-round nav-btn" onclick="switchView('view-wallet', this)">account_balance_wallet</span>
    </div>

    <div class="sheet-overlay" id="sheet-overlay" onclick="closeSheet()">
        <div class="bottom-sheet" onclick="event.stopPropagation()">
            <div class="sheet-handle"></div>
            
            <div class="type-toggle">
                <div id="tab-trip" class="type-btn active" onclick="toggleType('trip')">Êñ∞Â¢ûË°åÁ®ã</div>
                <div id="tab-exp" class="type-btn" onclick="toggleType('exp')">Êñ∞Â¢ûË®òÂ∏≥</div>
            </div>

            <div id="form-trip">
                <input type="time" id="trip-time" class="input-lg" value="10:00">
                <input type="text" id="trip-title" class="input-lg" placeholder="Âú∞Èªû (‰æãÂ¶Ç: Ê∑∫ËçâÂØ∫)">
                <input type="text" id="trip-note" class="input-lg" placeholder="ÂÇôË®ª (MapCode/ÈõªË©±)">
                <button class="big-btn" onclick="saveTrip()">Âä†ÂÖ•Ë°åÁ®ã</button>
            </div>

            <div id="form-exp" style="display:none;">
                <input type="number" id="exp-amt" class="input-lg" placeholder="ÈáëÈ°ç (Êó•Âπ£)" inputmode="numeric">
                <input type="text" id="exp-note" class="input-lg" placeholder="È†ÖÁõÆ (‰æãÂ¶Ç: ÊôöÈ§ê)">
                <div class="payer-row">
                    <div class="payer-chip active" id="pay-m" onclick="setPayer('M')">Êàë‰ªò</div>
                    <div class="payer-chip" id="pay-w" onclick="setPayer('W')">Â•π‰ªò</div>
                </div>
                <button class="big-btn" onclick="saveExp()">ÂÑ≤Â≠òÊ∂àË≤ª</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // ‚úÖ ‰Ω†ÁöÑÈáëÈë∞ (Â∑≤È†êÂ°´)
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyCbrzyXFiRYxGyt6crsRTQNQ5lfZnz65kA",
            authDomain: "tokyo-trip-2026-acfe6.firebaseapp.com",
            databaseURL: "https://tokyo-trip-2026-acfe6-default-rtdb.firebaseio.com",
            projectId: "tokyo-trip-2026-acfe6",
            storageBucket: "tokyo-trip-2026-acfe6.firebasestorage.app",
            messagingSenderId: "345730464055",
            appId: "1:345730464055:web:662b4c0391f893828c42b2",
            measurementId: "G-FKTG3ERB29"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentDay = 1;
        let selectedPayer = 'M';
        const rate = 0.22;

        // --- ÂàùÂßãÂåñ ---
        loadWeather(); // ËºâÂÖ•Â§©Ê∞£
        loadTrip();
        loadWallet();

        // --- 1. Â§©Ê∞£ÂäüËÉΩ (Open-Meteo API) ---
        async function loadWeather() {
            try {
                // Êù±‰∫¨Â∫ßÊ®ô: 35.6895, 139.6917
                const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=35.6895&longitude=139.6917&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo');
                const data = await res.json();
                const container = document.getElementById('weather-widget');
                container.innerHTML = '';

                // Â§©Ê∞£‰ª£Á¢ºËΩâ Icon
                const getIcon = (code) => {
                    if(code <= 3) return '‚òÄÔ∏è';
                    if(code <= 48) return '‚òÅÔ∏è';
                    if(code <= 67) return 'üåßÔ∏è';
                    return '‚õàÔ∏è';
                };

                // Áî¢Áîü 7 Â§©Âç°Áâá
                for(let i=0; i<7; i++) {
                    const date = new Date(data.daily.time[i]);
                    const dayName = date.toLocaleDateString('en-US', {weekday:'short'});
                    const code = data.daily.weathercode[i];
                    const max = Math.round(data.daily.temperature_2m_max[i]);
                    
                    container.innerHTML += `
                        <div class="weather-card">
                            <div class="w-day">${dayName}</div>
                            <div class="w-icon">${getIcon(code)}</div>
                            <div class="w-temp">${max}¬∞</div>
                        </div>
                    `;
                }
            } catch(e) {
                console.error(e);
                document.getElementById('weather-widget').innerHTML = '<span style="font-size:0.8rem;">Â§©Ê∞£ËºâÂÖ•Â§±Êïó</span>';
            }
        }

        // --- 2. Ë°åÁ®ãÈÇèËºØ ---
        function setDay(d) {
            currentDay = d;
            document.querySelectorAll('.date-chip').forEach(e => e.classList.remove('active'));
            event.currentTarget.classList.add('active');
            loadTrip();
        }
        function loadTrip() {
            const el = document.getElementById('itinerary-list');
            el.innerHTML = '<div style="text-align:center; padding:30px; opacity:0.5;">Loading...</div>';
            db.ref('schedule').orderByChild('day').equalTo(currentDay).once('value', snap => {
                el.innerHTML = '';
                const data = snap.val();
                if(!data) { el.innerHTML = '<div style="text-align:center; padding:40px; color:#666;">ÈªûÊìä‰∏ãÊñπ + Êñ∞Â¢ûË°åÁ®ã</div>'; return; }
                
                let arr = [];
                for(let k in data) arr.push({id:k, ...data[k]});
                arr.sort((a,b) => a.time.localeCompare(b.time));

                arr.forEach(item => {
                    el.innerHTML += `
                        <div class="card">
                            <div class="time-badge">${item.time}</div>
                            <div class="card-content">
                                <div class="card-title">${item.title}</div>
                                <div class="card-note">${item.note || ''}</div>
                                <div class="card-actions">
                                    <a href="https://www.google.com/maps/search/?api=1&query=${item.title}" target="_blank" class="btn-sm">
                                        <span class="material-icons-round" style="font-size:14px;">near_me</span> Â∞éËà™
                                    </a>
                                    <div class="btn-sm" onclick="delItem('schedule','${item.id}')" style="background:rgba(255,50,50,0.2); border-color:transparent;">Âà™Èô§</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            });
        }

        // --- 3. Ë®òÂ∏≥ÈÇèËºØ ---
        function loadWallet(filter = 'ALL') {
            const el = document.getElementById('expense-list');
            db.ref('expenses').on('value', snap => {
                el.innerHTML = '';
                let total = 0;
                const data = snap.val();
                if(data) {
                    let arr = [];
                    for(let k in data) arr.push({id:k, ...data[k]});
                    arr.reverse();
                    arr.forEach(item => {
                        if(filter !== 'ALL' && item.payer !== filter) return;
                        const twd = Math.round(item.amount * rate);
                        total += twd;
                        el.innerHTML += `
                            <div class="card" style="align-items:center;">
                                <div style="flex:1;">
                                    <div style="font-weight:700;">${item.note}</div>
                                    <div style="font-size:0.85rem; color:#888;">¬•${item.amount}</div>
                                </div>
                                <div style="text-align:right;">
                                    <div style="font-weight:700; font-size:1.1rem;">$${twd}</div>
                                    <div style="font-size:0.75rem; color:var(--accent);">${item.payer==='M'?'Êàë':'Â•π'}‰ªò</div>
                                </div>
                            </div>
                        `;
                    });
                }
                document.getElementById('display-total').innerText = '$' + total.toLocaleString();
            });
        }
        function filterWallet(who) { loadWallet(who); }

        // --- 4. Èù¢ÊùøËàá‰∫íÂãï ---
        function openSheet() { document.getElementById('sheet-overlay').classList.add('show'); }
        function closeSheet() { document.getElementById('sheet-overlay').classList.remove('show'); }
        
        function toggleType(t) {
            document.getElementById('form-trip').style.display = t==='trip'?'block':'none';
            document.getElementById('form-exp').style.display = t==='exp'?'block':'none';
            document.getElementById('tab-trip').classList.toggle('active', t==='trip');
            document.getElementById('tab-exp').classList.toggle('active', t==='exp');
        }
        
        function setPayer(who) {
            selectedPayer = who;
            document.getElementById('pay-m').classList.toggle('active', who==='M');
            document.getElementById('pay-w').classList.toggle('active', who==='W');
        }

        function saveTrip() {
            const t = document.getElementById('trip-title').value;
            if(!t) return alert('Ë´ãËº∏ÂÖ•Âú∞Èªû');
            db.ref('schedule').push({ day: currentDay, time: document.getElementById('trip-time').value, title: t, note: document.getElementById('trip-note').value });
            closeSheet(); loadTrip();
        }
        
        function saveExp() {
            const amt = document.getElementById('exp-amt').value;
            if(!amt) return alert('Ë´ãËº∏ÂÖ•ÈáëÈ°ç');
            db.ref('expenses').push({ amount: amt, note: document.getElementById('exp-note').value, payer: selectedPayer });
            closeSheet();
        }
        
        function delItem(path, id) { if(confirm('Âà™Èô§?')) db.ref(path+'/'+id).remove(); }
        
        function switchView(id, el) {
            document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
            el.classList.add('active');
        }

        if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
    </script>
</body>
</html>